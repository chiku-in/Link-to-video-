import requests
from telegram import InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, CallbackQueryHandler

API_URL = "https://your-deployed-domain.com/download"
REQUIRED_CHANNELS = ["@yourchannel1", "@yourchannel2"]  # <-- à¤…à¤ªà¤¨à¥‡ à¤šà¥ˆà¤¨à¤² à¤•à¥‡ à¤¯à¥‚à¤œà¤°à¤¨à¥‡à¤® à¤¡à¤¾à¤²à¥‡à¤‚

# à¤¯à¥‚à¤œà¤° à¤•à¥‡ à¤šà¥ˆà¤¨à¤² à¤®à¥‡à¤‚ à¤¸à¤¦à¤¸à¥à¤¯à¤¤à¤¾ à¤•à¥€ à¤œà¤¾à¤‚à¤š à¤•à¤°à¥‡à¤‚
async def is_user_subscribed(user_id, context):
    for channel in REQUIRED_CHANNELS:
        try:
            member = await context.bot.get_chat_member(chat_id=channel, user_id=user_id)
            if member.status in ['left', 'kicked']:
                return False
        except Exception:
            return False
    return True

# /start à¤•à¤®à¤¾à¤‚à¤¡ à¤¹à¥ˆà¤‚à¤¡à¤²à¤°
async def start(update: ContextTypes.DEFAULT_TYPE, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if not await is_user_subscribed(user_id, context):
        keyboard = [
            [InlineKeyboardButton("ðŸ”— Join Channel 1", url="https://t.me/yourchannel1")],
            [InlineKeyboardButton("ðŸ”— Join Channel 2", url="https://t.me/yourchannel2")],
            [InlineKeyboardButton("âœ… I've Joined", callback_data="check_sub")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text(
            "â›” à¤¬à¥‰à¤Ÿ à¤•à¤¾ à¤‡à¤¸à¥à¤¤à¥‡à¤®à¤¾à¤² à¤•à¤°à¤¨à¥‡ à¤¸à¥‡ à¤ªà¤¹à¤²à¥‡ à¤¦à¥‹à¤¨à¥‹à¤‚ à¤šà¥ˆà¤¨à¤² à¤•à¥‹ à¤œà¥‰à¤‡à¤¨ à¤•à¤°à¥‡à¤‚:",
            reply_markup=reply_markup
        )
        return
    await update.message.reply_text("âœ… Welcome! Send a TeraBox link to get download/watch options.")

# CallbackQueryHandler à¤•à¥‡ à¤²à¤¿à¤ "I've Joined" à¤¬à¤Ÿà¤¨ à¤•à¥€ à¤œà¤¾à¤‚à¤š
async def check_subscription(update: ContextTypes.DEFAULT_TYPE, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id
    if await is_user_subscribed(user_id, context):
        await query.edit_message_text("âœ… à¤§à¤¨à¥à¤¯à¤µà¤¾à¤¦! à¤…à¤¬ à¤†à¤ª à¤¬à¥‰à¤Ÿ à¤•à¤¾ à¤‡à¤¸à¥à¤¤à¥‡à¤®à¤¾à¤² à¤•à¤° à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚à¥¤\nà¤…à¤¬ à¤•à¥‹à¤ˆ à¤­à¥€ TeraBox à¤²à¤¿à¤‚à¤• à¤­à¥‡à¤œà¥‡à¤‚à¥¤")
    else:
        await query.edit_message_text("âŒ à¤†à¤ª à¤…à¤­à¥€ à¤¤à¤• à¤¦à¥‹à¤¨à¥‹à¤‚ à¤šà¥ˆà¤¨à¤² à¤•à¥‹ à¤œà¥‰à¤‡à¤¨ à¤¨à¤¹à¥€à¤‚ à¤•à¤¿à¤ à¤¹à¥ˆà¤‚à¥¤ à¤ªà¤¹à¤²à¥‡ à¤œà¥‰à¤‡à¤¨ à¤•à¤°à¥‡à¤‚à¥¤")

# à¤¯à¥‚à¤œà¤° à¤•à¥‡ à¤²à¤¿à¤‚à¤• à¤¹à¥ˆà¤‚à¤¡à¤²à¤° à¤®à¥‡à¤‚ à¤­à¥€ à¤šà¥ˆà¤¨à¤² à¤šà¥‡à¤• (optional, à¤¬à¥‡à¤¹à¤¤à¤° à¤¸à¤¿à¤•à¥à¤¯à¥‹à¤°à¤¿à¤Ÿà¥€ à¤•à¥‡ à¤²à¤¿à¤)
async def handle_link(update: ContextTypes.DEFAULT_TYPE, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if not await is_user_subscribed(user_id, context):
        await update.message.reply_text("â›” à¤•à¥ƒà¤ªà¤¯à¤¾ à¤ªà¤¹à¤²à¥‡ à¤¦à¥‹à¤¨à¥‹à¤‚ à¤šà¥ˆà¤¨à¤² à¤•à¥‹ à¤œà¥‰à¤‡à¤¨ à¤•à¤°à¥‡à¤‚à¥¤")
        return

    try:
        res = requests.post(API_URL, json={"url": update.message.text})
        resp = res.json()
        if resp.get("status") == "success":
            info = resp["data"]
            buttons = [
                [InlineKeyboardButton("â–¶ï¸ Watch", url=info["resolutions"].get("HD Video"))],
                [InlineKeyboardButton("â¬‡ï¸ Download", url=info["resolutions"].get("Fast Download"))]
            ]
            await update.message.reply_photo(
                photo=info["thumbnail"],
                caption=f"ðŸŽ¬ {info['title']}",
                reply_markup=InlineKeyboardMarkup(buttons)
            )
        else:
            await update.message.reply_text("Error: " + resp.get("message", "Unknown"))
    except Exception:
        await update.message.reply_text("Failed to fetch video.")

app = Application.builder().token("YOUR_BOT_TOKEN").build()
app.add_handler(CommandHandler("start", start))
app.add_handler(CallbackQueryHandler(check_subscription, pattern="check_sub"))
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_link))
app.run_polling()
